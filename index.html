<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Väderklocka</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background: #ffffff;
      color: #000000;
      transition: background-color 1s ease, color 1s ease;
      position: relative;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    #clock { font-size: 25vw; text-align: center; margin: 20px 0 10px 0; line-height: .9; }
    .columns { display: flex; width: 100%; height: 100%; }
    .left, .right {
      flex: 1; position: relative; display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start; padding-top: 30px;
      transition: background-color 0.6s ease, color 0.6s ease;
    }
    .weather-icon {
      width: 100%; height: auto; filter: drop-shadow(0 0 4px black);
      position: absolute; top: 0; left: 0; z-index: 0;
      pointer-events: none;
    }
    .temp-now, .temp-forecast {
      font-size: 8vw; position: absolute; top: 50%; width: 100%;
      text-align: center; z-index: 1; margin-top: 20px;
      text-shadow: 0 0 6px rgba(0,0,0,.35);
    }
    .forecast-time { font-size: 5vw; margin-top: 10px; opacity: 0.8; }

    .color-scale-container { position: absolute; top: 10px; left: 10%;
      width: 80%; height: 30px; display: flex; justify-content: space-between; z-index: 10;
    }
    .color-segment-wrapper { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .color-segment { width: 100%; height: 6px; }
    .temp-label { font-size: 10px; color: black; margin-top: 2px; }
    .temp-indicator-now, .temp-indicator-forecast {
      position: absolute; top: 6px; width: 10px; height: 10px;
      border-radius: 50%; z-index: 11;
    }
    .temp-indicator-now { background-color: red; }
    .temp-indicator-forecast { background-color: black; }

    :root { --left-bg: #ffffff; --right-bg: #ffffff; }
    body::before {
      content: ''; position: fixed; inset: 0; z-index: -1;
      background: linear-gradient(to right,
        var(--left-bg, #ffffff) 0 50%,
        var(--right-bg, #ffffff) 50% 100%);
    }

    /* Testknapp */
    .test-speak {
      position: fixed;
      right: calc(12px + env(safe-area-inset-right));
      bottom: calc(12px + env(safe-area-inset-bottom));
      padding: 12px 16px;
      min-width: 180px; min-height: 48px;
      border: 0; border-radius: 12px;
      background: #111; color: #fff; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,.2);
      opacity: .95; z-index: 10000;
      pointer-events: auto;
      font-size: 16px;
    }
    .test-speak:active { transform: scale(0.98); }

    /* Röstpanel */
    .voice-panel {
      position: fixed; left: 12px; bottom: 12px; z-index: 10000;
      background: rgba(0,0,0,0.85); color: #fff;
      padding: 10px; border-radius: 12px; max-width: 80vw; font-size: 12px;
    }
    .voice-panel select, .voice-panel input[type="range"], .voice-panel button { width: 100%; }
    .voice-panel button {
      margin-top: 6px; padding: 6px 8px; border-radius: 8px; border: 0; background: #1e88e5; color: #fff;
    }

    /* HELSKÄRMS-OVERLAY FÖR LJUDAKTIVERING */
    #tap-unlock {
      position: fixed; inset: 0; z-index: 20000;
      display: flex; align-items: center; justify-content: center;
      background: #000; color: #fff;
    }
    #tap-unlock button {
      font-size: 20px; padding: 16px 22px; border-radius: 14px; border: none; cursor: pointer;
      background: #1e88e5; color: #fff;
    }

    /* Liten statusrad */
    #status {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: calc(70px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.8); color: #fff; padding: 6px 10px;
      border-radius: 8px; font-size: 12px; z-index: 10000; min-width: 160px; text-align: center;
    }
  </style>
</head>
<body>

<!-- Helskärms-knapp: MÅSTE tryckas en gång på iPad/Chrome -->
<div id="tap-unlock">
  <button id="btn-unlock" type="button">🔊 Tryck för att aktivera ljud</button>
</div>

<div id="status" hidden>status…</div>

<!-- Skala & indikatorer -->
<div id="temp-indicator-now" class="temp-indicator-now"></div>
<div id="temp-indicator-forecast" class="temp-indicator-forecast"></div>
<div class="color-scale-container">
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#001d4a;"></div><div class="temp-label">-20°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#003b8b;"></div><div class="temp-label">-15°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#005fc1;"></div><div class="temp-label">-10°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#3399ff;"></div><div class="temp-label">-5°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#33cccc;"></div><div class="temp-label">0°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#66ffcc;"></div><div class="temp-label">5°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#a8e6cf;"></div><div class="temp-label">10°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#66bb6a;"></div><div class="temp-label">15°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#cddc39;"></div><div class="temp-label">20°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#fff176;"></div><div class="temp-label">23°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#ffc107;"></div><div class="temp-label">26°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#ff9800;"></div><div class="temp-label">30°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#ff5722;"></div><div class="temp-label">35°</div></div>
  <div class="color-segment-wrapper"><div class="color-segment" style="background-color:#f44336;"></div><div class="temp-label">40°</div></div>
</div>

<!-- Klocka & kolumner -->
<div id="clock">--:--</div>
<div class="columns">
  <div class="left">
    <img id="now-icon" src="" class="weather-icon" alt="väder nu" />
    <div id="temp-now" class="temp-now">-- °C</div>
  </div>
  <div class="right">
    <img id="forecast-icon" src="" class="weather-icon" alt="prognos" />
    <div id="forecast-time" class="forecast-time">--:--</div>
    <div id="temp-forecast" class="temp-forecast">-- °C</div>
  </div>
</div>

<!-- Testknapp -->
<button class="test-speak" id="btn-test" type="button" aria-label="Testa tal nu">🔊 Testa tal nu</button>

<!-- Röstpanel -->
<div class="voice-panel">
  <div style="margin-bottom:6px">Röst:</div>
  <select id="voice-select"><option>laddar röster…</option></select>
  <label>Hastighet <input id="rate" type="range" min="0.6" max="1.4" step="0.05" value="1.0"></label>
  <label>Tonhöjd <input id="pitch" type="range" min="0.8" max="1.2" step="0.05" value="1.0"></label>
  <button id="try-voice">🔉 Prova vald röst</button>
  <div id="voice-info" style="margin-top:6px;opacity:.8">Vald: okänd</div>
</div>

<script>
  /* ===== KLOCKA ===== */
  function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit', hour12: false });
    document.getElementById('clock').textContent = time;
  }

  /* ===== FÄRG/BG ===== */
  function getBackgroundColor(temp) {
    if (temp <= -20) return '#001d4a';
    else if (temp <= -15) return '#003b8b';
    else if (temp <= -10) return '#005fc1';
    else if (temp <= -5) return '#3399ff';
    else if (temp <= 0) return '#33cccc';
    else if (temp <= 5) return '#66ffcc';
    else if (temp <= 10) return '#a8e6cf';
    else if (temp <= 15) return '#66bb6a';
    else if (temp <= 20) return '#cddc39';
    else if (temp <= 23) return '#fff176';
    else if (temp <= 26) return '#ffc107';
    else if (temp <= 30) return '#ff9800';
    else if (temp <= 35) return '#ff5722';
    else return '#f44336';
  }

  /* ===== VÄDER/UI ===== */
  async function updateUIAndGetData() {
    const apiKey = '520bfebd2e95a6b1a08befe3286c9ca1';
    const city = 'Bromma,SE';
    const urlNow = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=sv`;
    const urlForecast = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric&lang=sv`;

    const [resNow, resForecast] = await Promise.all([fetch(urlNow), fetch(urlForecast)]);
    const dataNow = await resNow.json();
    const dataForecast = await resForecast.json();

    const tempNow = Math.round(dataNow.main.temp);
    const iconNow = dataNow.weather[0].icon;
    document.getElementById('temp-now').textContent = `${tempNow} °C`;
    document.getElementById('now-icon').src = `https://openweathermap.org/img/wn/${iconNow}@4x.png`;
    document.getElementById('temp-now').style.color = tempNow <= 0 ? '#3399ff' : '#e60000';
    document.documentElement.style.setProperty('--left-bg', getBackgroundColor(tempNow));

    const forecast = dataForecast.list[1];
    const tempForecast = Math.round(forecast.main.temp);
    const iconForecast = forecast.weather[0].icon;
    const time = new Date(forecast.dt * 1000).toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit', hour12: false });
    document.getElementById('temp-forecast').textContent = `${tempForecast}°C`;
    document.getElementById('forecast-icon').src = `https://openweathermap.org/img/wn/${iconForecast}@4x.png`;
    document.getElementById('forecast-time').textContent = time;
    document.getElementById('temp-forecast').style.color = tempForecast <= 0 ? '#3399ff' : '#e60000';
    document.documentElement.style.setProperty('--right-bg', getBackgroundColor(tempForecast));

    setTempIndicator('temp-indicator-now', tempNow);
    setTempIndicator('temp-indicator-forecast', tempForecast);

    const nowDesc = (dataNow.weather?.[0]?.description || "").toLowerCase();
    return { nowTemp: dataNow.main.temp, nowDesc, forecastList: dataForecast.list };
  }

  function setTempIndicator(id, tempC) {
    const minTemp = -20, maxTemp = 40;
    const scaleContainer = document.querySelector('.color-scale-container');
    const indicator = document.getElementById(id);
    if (!scaleContainer || !indicator) return;
    const fullWidth = scaleContainer.offsetWidth;
    const relative = Math.min(Math.max((tempC - minTemp) / (maxTemp - minTemp), 0), 1);
    const pixelPos = relative * fullWidth;
    indicator.style.left = `calc(10% + ${pixelPos - 5}px)`;
  }

  /* ===== TAL (svenska) ===== */
  let speechPrimed = false;
  let svVoice = null;
  let audioCtx = null;
  let chosenVoiceName = localStorage.getItem("voiceName") || null;
  let chosenRate = parseFloat(localStorage.getItem("voiceRate") || "1.0");
  let chosenPitch = parseFloat(localStorage.getItem("voicePitch") || "1.0");

  function status(msg) {
    const s = document.getElementById('status');
    if (!s) return;
    s.textContent = msg;
    s.hidden = false;
    clearTimeout(status._t);
    status._t = setTimeout(()=>{ s.hidden = true; }, 2500);
  }

  function listVoices() { return (speechSynthesis.getVoices() || []).slice(); }

  function getChosenVoice() {
    const voices = listVoices();
    return voices.find(v => v.name === chosenVoiceName) || null;
  }

  function pickSwedishFemaleVoice() {
    const voices = listVoices();
    const norm = s => (s || "").toLowerCase();
    const sv = voices.filter(v => norm(v.lang).startsWith("sv"));
    const femaleNames = ["alva","tove","siri","elin","maria","anna","klara","agnes"];
    const svFemale = sv.find(v => femaleNames.some(n => norm(v.name).includes(n)));
    if (svFemale) return svFemale;
    const googleSv = sv.find(v => norm(v.name).includes("google"));
    if (googleSv) return googleSv;
    return sv[0] || voices[0] || null;
  }

  // Helskärms-aktivering: MÅSTE ske synkront i samma tryck
  function unlockAudioAndSpeech() {
    try {
      // 1) WebAudio: starta och spela en snabb beep för att öppna ljudkanalen
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = "sine"; o.frequency.value = 880;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.01);
      o.start();
      o.stop(audioCtx.currentTime + 0.08);

      // 2) TTS: kort svensk fras – i samma eventloop
      svVoice = getChosenVoice() || pickSwedishFemaleVoice();
      const u = new SpeechSynthesisUtterance("Tal aktiverat.");
      if (svVoice) u.voice = svVoice;
      u.lang = (svVoice && (svVoice.lang||"").toLowerCase().startsWith("sv")) ? svVoice.lang : "sv-SE";
      u.volume = 1.0; u.rate = chosenRate || 1.0; u.pitch = chosenPitch || 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);

      speechPrimed = true;
      status("Ljud aktiverat");

      // Dölj overlay
      const overlay = document.getElementById('tap-unlock');
      if (overlay) overlay.style.display = 'none';

      // När röster laddats: finjustera vald röst + UI
      if (speechSynthesis.onvoiceschanged !== undefined) {
        const once = () => { speechSynthesis.onvoiceschanged = null; populateVoiceSelect(); };
        speechSynthesis.onvoiceschanged = once;
      } else {
        populateVoiceSelect();
      }
    } catch (e) {
      console.warn("unlockAudioAndSpeech fel:", e);
      status("Kunde inte aktivera ljud");
    }
  }

function speak(text) {
  if (document.visibilityState !== "visible" || !speechPrimed) return;
  try {
    const v = getChosenVoice() || svVoice;
    const u = new SpeechSynthesisUtterance(text);
    if (v && (v.lang || "").toLowerCase().startsWith("sv")) {
      u.voice = v;
      u.lang = v.lang;
    } else {
      // stoppa och visa instruktion om ingen svensk röst finns
      status("Ingen svensk röst – installera i iOS Inställningar.");
      return;
    }
    u.volume = 1.0; u.rate = chosenRate || 1.0; u.pitch = chosenPitch || 1.0;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } catch(e) {
    console.warn("Kunde inte tala:", e);
  }
  }

  /* ===== Sammanfattning ===== */
  function trendWord(delta) {
    const a = Math.abs(delta);
    if (a < 0.6) return "vara ungefär oförändrad";
    return delta > 0 ? "stiga" : "sjunka";
  }
  function summarizeToday(nowTemp, nowDesc, forecastList) {
    if (!forecastList || !forecastList.length) {
      return { text: `Just nu är det ${Math.round(nowTemp)} grader och ${nowDesc}.` };
    }
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
    const today = forecastList.filter(item => {
      const t = new Date(item.dt * 1000);
      return t.getFullYear() === y && t.getMonth() === m && t.getDate() === d;
    });
    const daySet = today.length ? today : forecastList.slice(0, Math.min(8, forecastList.length));
    const temps = daySet.map(i => i.main.temp);
    const tMin = Math.min(...temps), tMax = Math.max(...temps);
    let tNoon = null, bestDiff = Infinity;
    for (const i of daySet) {
      const t = new Date(i.dt * 1000);
      const diff = Math.abs(t.getHours() + t.getMinutes()/60 - 12);
      if (diff < bestDiff) { bestDiff = diff; tNoon = i.main.temp; }
    }
    const delta = (tMax + tMin)/2 - nowTemp;
    const trend = trendWord(delta);
    const text =
      `Just nu är det ${Math.round(nowTemp)} grader och ${nowDesc}. ` +
      `Under dagen väntas som lägst ${Math.round(tMin)} och som högst ${Math.round(tMax)} grader, ` +
      `och temperaturen ser ut att ${trend}.` +
      (tNoon != null ? ` Runt lunchtid cirka ${Math.round(tNoon)} grader.` : "");
    return { text };
  }

  async function announceOnce() {
    try {
      const data = await updateUIAndGetData();
      const { text } = summarizeToday(data.nowTemp, data.nowDesc, data.forecastList);
      speak(text);
    } catch(e) {
      console.warn("announceOnce fel:", e);
      status("Väderhämtning/tal fel");
    }
  }

  /* ===== Schema ===== */
  (function scheduleAnnouncements() {
    let lastStamp = "";
    let lastDay = (new Date()).getDate();
    setInterval(() => {
      const now = new Date();
      const day = now.getDate();
      if (day !== lastDay) { lastStamp = ""; lastDay = day; }
      const dow = now.getDay(); // 0=sön ... 6=lör
      const h = now.getHours();
      const m = now.getMinutes();
      const stamp = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()} ${h}:${m}`;
      const isWeekday = dow >= 1 && dow <= 5;
      const isWeekend = dow === 0 || dow === 6;
      let shouldSpeak = false;
      if (isWeekday && ((h === 6 && (m === 30 || m === 40 || m === 50)) || (h === 7 && m === 0))) shouldSpeak = true;
      if (isWeekend && h === 9 && m === 0) shouldSpeak = true;
      if (h === 18 && m === 5) shouldSpeak = true; // 18:05 alla dagar
      if (shouldSpeak && stamp !== lastStamp) { lastStamp = stamp; announceOnce(); }
    }, 15000);
  })();

  /* ===== Röstpanel ===== */
function populateVoiceSelect() {
  const sel = document.getElementById("voice-select");
  const info = document.getElementById("voice-info");
  if (!sel) return;

  const voices = (speechSynthesis.getVoices() || []).slice();
  const svVoices = voices.filter(v => (v.lang || "").toLowerCase().startsWith("sv"));

  sel.innerHTML = "";

  if (!svVoices.length) {
    const opt = document.createElement("option");
    opt.textContent = "Inga svenska röster – installera i Inställningar → Hjälpmedel → Talat innehåll → Röster → Svenska";
    sel.appendChild(opt);
    if (info) info.textContent = "Installera en svensk röst i iOS och starta om Chrome.";
    return;
  }

  svVoices.sort((a,b) => (a.name||"").localeCompare(b.name||""));
  svVoices.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} — ${v.lang}`;
    sel.appendChild(opt);
  });

  // Välj tidigare sparad, annars första svenska
  let def = svVoices.find(v => v.name === chosenVoiceName) || svVoices[0];
  sel.value = def.name;
  chosenVoiceName = def.name;
  localStorage.setItem("voiceName", chosenVoiceName);
  svVoice = def;
  if (info) info.textContent = `Vald: ${def.name} (${def.lang})`;
}

  /* ===== Init ===== */
  updateClock();
  setInterval(updateClock, 1000);
  updateUIAndGetData();
  setInterval(updateUIAndGetData, 10 * 60 * 1000);

  document.addEventListener('DOMContentLoaded', () => {
    // Helskärms-aktivering: MÅSTE ske synkront
    const unlockBtn = document.getElementById('btn-unlock');
    const unlockHandler = (e) => {
      e.preventDefault(); // undvik “ghost click”
      unlockAudioAndSpeech();
    };
    unlockBtn.addEventListener('touchstart', unlockHandler, { passive: false });
    unlockBtn.addEventListener('click', unlockHandler);

    // Testknapp – kräver att unlock är gjort först
    const btn = document.getElementById('btn-test');
    const handler = (e) => {
      if (e.type === 'touchstart') e.preventDefault();
      if (!speechPrimed) { status("Tryck först på 'Aktivera ljud'"); return; }
      announceOnce();
    };
    btn.addEventListener('touchstart', handler, { passive: false });
    btn.addEventListener('click', handler);

    // Röstlista
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = () => { populateVoiceSelect(); };
    }
    populateVoiceSelect();

    // Röstpanel-händelser
    const sel = document.getElementById("voice-select");
    const info = document.getElementById("voice-info");
    const rate = document.getElementById("rate");
    const pitch = document.getElementById("pitch");
    const tryBtn = document.getElementById("try-voice");

    sel.addEventListener("change", ()=>{
      chosenVoiceName = sel.value;
      localStorage.setItem("voiceName", chosenVoiceName);
      const v = listVoices().find(v => v.name === chosenVoiceName);
      if (v) { svVoice = v; if (info) info.textContent = `Vald: ${v.name} (${v.lang})`; }
    });
    rate.addEventListener("input", ()=>{
      chosenRate = parseFloat(rate.value);
      localStorage.setItem("voiceRate", String(chosenRate));
    });
    pitch.addEventListener("input", ()=>{
      chosenPitch = parseFloat(pitch.value);
      localStorage.setItem("voicePitch", String(chosenPitch));
    });
    tryBtn.addEventListener("click", ()=>{
      if (!speechPrimed) { status("Tryck först på 'Aktivera ljud'"); return; }
      speak("Hej! Detta är ett rösttest på svenska.");
    });
  });
</script>

</body>
</html>
